version: 2

models:
  - name: int_experiment_exposures_deduped
    description: "Deterministically deduped exposure events for each experiment/unit/variation."
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - experiment_id
              - unit_id
              - variation_id
    columns:
      - name: experiment_id
        tests:
          - not_null
      - name: unit_id
        tests:
          - not_null
      - name: variation_id
        tests:
          - not_null
      - name: occurred_at
        tests:
          - not_null
      - name: event_id
        tests:
          - not_null

  - name: int_experiment_exposure_validation
    description: "Assignment-to-exposure validation table at experiment_id x unit_id grain."
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - experiment_id
              - unit_id
      - exposure_not_too_early:
          arguments:
            assigned_ts: assigned_at
            exposure_ts: first_exposure_at
            grace_minutes: "{{ var('exp_allow_pre_assignment_exposure_grace_minutes', 5) }}"
    columns:
      - name: experiment_id
        tests:
          - not_null
      - name: unit_id
        tests:
          - not_null
      - name: assigned_at
        tests:
          - not_null
      - name: assigned_variation_id
        tests:
          - not_null
      - name: validation_status
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - "valid"
                  - "no_exposure"
                  - "multi_variation_exposure"
                  - "pre_assignment_exposure"
                  - "exposure_outside_window"
                  - "variant_mismatch"
                  - "invalid_other"
